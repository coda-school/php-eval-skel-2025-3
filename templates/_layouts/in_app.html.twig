{% extends 'base.html.twig' %}

{% block body %}
    <div class="stela-bg min-h-screen text-[#e7e5e4] font-serif selection:bg-[#c5a059] selection:text-black relative">

        {# --- 1. TOASTS --- #}
        <div id="stela-toast-container" class="fixed bottom-6 right-6 z-[200] flex flex-col gap-4 pointer-events-none">
            {% for type, messages in app.flashes %}
                {% for message in messages %}
                    <div class="stela-toast pointer-events-auto flex items-center gap-4 bg-[#1c1917] border border-[#c5a059] px-6 py-4 shadow-[0_0_20px_rgba(197,160,89,0.2)] rounded transform translate-y-10 opacity-0 transition-all duration-500 ease-out" role="alert">
                        <div class="text-[#c5a059] text-2xl animate-pulse">✦</div>
                        <div>
                            <p class="text-[#e7e5e4] text-sm font-serif font-bold">{{ message }}</p>
                        </div>
                        <button type="button" class="ml-4 text-[#78716c] hover:text-[#c5a059] transition" onclick="this.parentElement.remove()">✕</button>
                    </div>
                {% endfor %}
            {% endfor %}
        </div>

        {# --- 2. MODALE DE SUPPRESSION --- #}
        <div id="stela-delete-modal" class="fixed inset-0 z-[200] hidden items-center justify-center">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0 modal-backdrop"></div>
            <div class="stela-slab w-full max-w-md relative transform scale-95 opacity-0 transition-all duration-300 modal-panel p-8 border border-red-900/50 shadow-[0_0_50px_rgba(200,0,0,0.2)]">
                <div class="stela-texture opacity-20"></div>
                <div class="relative z-10 text-center">
                    <div class="text-red-500 text-4xl mb-4">⚠</div>
                    <h3 class="text-xl font-cinzel font-bold text-[#e7e5e4] mb-2">{{ 'modal.delete_title'|trans({}, 'stela') }}</h3>
                    <p class="text-[#78716c] mb-8 text-sm">{{ 'modal.delete_confirm'|trans({}, 'stela') }}</p>
                    <div class="flex justify-center gap-4">
                        <button type="button" id="cancel-delete" class="px-6 py-2 border border-[#44403c] text-[#78716c] hover:text-[#e7e5e4] hover:border-[#e7e5e4] transition font-cinzel text-xs uppercase tracking-widest rounded-sm">
                            {{ 'modal.cancel'|trans({}, 'stela') }}
                        </button>
                        <button type="button" id="confirm-delete" class="px-6 py-2 bg-red-900/30 border border-red-800 text-red-400 hover:bg-red-800 hover:text-white transition font-cinzel text-xs uppercase tracking-widest rounded-sm shadow-[0_0_15px_rgba(220,38,38,0.3)]">
                            {{ 'modal.confirm'|trans({}, 'stela') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {# --- LAYOUT GRID --- #}
        <div class="grid gap-0 {% if hide_sidebar_right|default(false) %}grid-cols-[68px_1fr] lg:grid-cols-[88px_1fr] xl:grid-cols-[275px_1fr]{% else %}grid-cols-[68px_1fr] lg:grid-cols-[88px_600px_1fr] xl:grid-cols-[275px_600px_1fr]{% endif %} max-w-[1300px] mx-auto min-h-screen stela-layout">

            {# ZONE NAV #}
            <div class="sticky top-0 h-screen z-50 flex justify-end bg-[#0c0a09]/50 backdrop-blur-sm xl:bg-transparent">
                <header class="h-full flex flex-col justify-between py-6 px-2 xl:px-4 w-full max-w-[275px]">
                    <div>
                        <div class="mb-8 px-2 xl:px-4 flex justify-center xl:justify-start">
                            <a href="{{ path('app_home') }}" class="block group">
                                <span class="xl:hidden text-3xl text-[#c5a059]">✦</span>
                                <h1 class="hidden xl:block text-3xl text-[#c5a059] font-cinzel font-bold tracking-widest drop-shadow-[0_4px_10px_rgba(197,160,89,0.3)] group-hover:scale-105 transition-transform">{{ 'title'|trans({}, 'stela') }}</h1>
                            </a>
                        </div>
                        <nav class="space-y-4 flex flex-col items-center xl:items-stretch">
                            <a href="{{ path('app_home') }}" class="flex items-center gap-4 p-3 rounded-full transition-all group w-max xl:w-auto {% if app.request.get('_route') == 'app_home' %}text-[#c5a059]{% else %}text-[#e7e5e4] hover:bg-[#c5a059]/10 hover:text-[#c5a059]{% endif %}">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                                <span class="text-xl font-bold hidden xl:block font-cinzel tracking-wide">{{ 'menu.sanctuary'|trans({}, 'stela') }}</span>
                            </a>
                            {% if app.user %}
                                <a href="{{ path('app_user_show', {'id': app.user.id}) }}" class="flex items-center gap-4 p-3 rounded-full transition-all group w-max xl:w-auto {% if app.request.get('_route') == 'app_user_show' and app.request.get('id') == app.user.id %}text-[#c5a059]{% else %}text-[#e7e5e4] hover:bg-[#c5a059]/10 hover:text-[#c5a059]{% endif %}">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                    <span class="text-xl font-bold hidden xl:block font-cinzel tracking-wide">{{ 'menu.incarnation'|trans({}, 'stela') }}</span>
                                </a>
                                <a href="{{ path('app_user_settings') }}" class="flex items-center gap-4 p-3 rounded-full transition-all group w-max xl:w-auto {% if app.request.get('_route') == 'app_user_settings' %}text-[#c5a059]{% else %}text-[#e7e5e4] hover:bg-[#c5a059]/10 hover:text-[#c5a059]{% endif %}">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                    <span class="text-xl font-bold hidden xl:block font-cinzel tracking-wide">{{ 'menu.ritual'|trans({}, 'stela') }}</span>
                                </a>
                            {% endif %}
                            <a href="{{ path('app_logout') }}" class="flex items-center gap-4 p-3 rounded-full text-red-400/70 hover:text-red-500 hover:bg-red-900/10 transition-all group mt-4 w-max xl:w-auto">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                                <span class="text-xl font-bold hidden xl:block font-cinzel tracking-wide">{{ 'menu.leave'|trans({}, 'stela') }}</span>
                            </a>
                        </nav>
                    </div>
                    {% if app.user %}
                        <div class="flex items-center gap-3 p-3 rounded-full hover:bg-[#1c1917] cursor-pointer transition border border-transparent hover:border-[#292524] justify-center xl:justify-start">
                            <div class="w-10 h-10 rounded-full bg-[#c5a059] flex items-center justify-center text-[#0c0a09] font-bold text-lg overflow-hidden flex-shrink-0">
                                {% if app.user.avatar %}
                                    <img src="{{ asset(app.user.avatar) }}" class="w-full h-full object-cover" alt="{{ app.user.username }}">
                                {% else %}
                                    {{ app.user.username|slice(0,1)|upper }}
                                {% endif %}
                            </div>
                            <div class="hidden xl:block overflow-hidden">
                                <p class="font-bold text-sm text-[#e7e5e4] truncate font-cinzel">{{ app.user.getName() }}</p>
                                <p class="text-xs text-[#78716c] truncate">@{{ app.user.username }}</p>
                            </div>
                        </div>
                    {% endif %}
                </header>
            </div>

            {# ZONE CONTENU #}
            <main class="border-l border-r border-[#292524] min-h-screen relative w-full {{ hide_sidebar_right|default(false) ? 'max-w-full' : 'max-w-[600px]' }}">
                {% block content %}{% endblock %}
            </main>

            {# ZONE SIDEBAR #}
            {% if not hide_sidebar_right|default(false) %}
                <aside class="hidden lg:block p-6 sticky top-0 h-screen overflow-y-auto pl-8 stela-sidebar-right">
                    <div class="relative group mb-8">
                        <span class="absolute left-4 top-3 text-[#57534e] group-focus-within:text-[#c5a059] transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        </span>
                        <input type="text"
                               aria-label="{{ 'sidebar.search_placeholder'|trans({}, 'stela') }}"
                               placeholder="{{ 'sidebar.search_placeholder'|trans({}, 'stela') }}"
                               class="w-full bg-[#1c1917] text-[#e7e5e4] rounded-full py-3 pl-12 pr-4 border border-transparent focus:border-[#c5a059] focus:bg-black focus:outline-none transition-all placeholder-[#57534e] shadow-lg">
                    </div>
                    <div class="stela-slab w-full rounded-xl border border-[#292524] bg-[#1c1917] p-4 relative overflow-hidden">
                        <div class="stela-texture opacity-30"></div>
                        <div class="relative z-10">
                            <h3 class="font-cinzel font-bold text-lg mb-4 text-[#e7e5e4] border-b border-[#292524] pb-2">
                                {{ 'sidebar.trends_title'|trans({}, 'stela') }}
                            </h3>
                            <div class="space-y-4">
                                <div class="py-2 cursor-pointer hover:bg-[#292524]/50 -mx-2 px-2 rounded transition">
                                    <p class="text-[10px] text-[#78716c] uppercase tracking-wider flex justify-between">
                                        <span>Royaume</span>
                                        <span>• En direct</span>
                                    </p>
                                    <p class="font-bold text-[#c5a059]">Le Code d'Hammurabi</p>
                                    <p class="text-xs text-[#57534e] mt-1">1,204 {{ 'tweet.plural'|trans({}, 'stela')|lower }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-[10px] text-[#57534e] leading-relaxed px-2">
                        <p>{{ 'sidebar.footer_rights'|trans({}, 'stela') }}</p>
                    </div>
                </aside>
            {% endif %}
        </div>
    </div>

    {# --- LOGIQUE JAVASCRIPT --- #}
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // 1. TOASTS & TRIGGERS
            const showToast = (toast) => {
                setTimeout(() => toast.classList.remove('translate-y-10', 'opacity-0'), 100);
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-x-full');
                    setTimeout(() => toast.remove(), 500);
                }, 4000);
            };
            document.querySelectorAll('.stela-toast').forEach((toast, index) => {
                setTimeout(() => showToast(toast), index * 200);
            });

            document.querySelectorAll('.stela-flash-trigger').forEach(trigger => {
                const message = trigger.dataset.message;
                const container = document.getElementById('stela-toast-container');
                if(container && message) {
                    const toast = document.createElement('div');
                    toast.className = "stela-toast pointer-events-auto flex items-center gap-4 bg-[#1c1917] border border-red-900 px-6 py-4 shadow-[0_0_20px_rgba(200,0,0,0.2)] rounded transform translate-y-10 opacity-0 transition-all duration-500 ease-out";
                    toast.innerHTML = `<div class="text-red-500 text-2xl animate-pulse">⚠</div><div><p class="text-[#e7e5e4] text-sm font-serif font-bold">${message}</p></div><button type="button" class="ml-4 text-[#78716c] hover:text-red-500 transition" onclick="this.parentElement.remove()">✕</button>`;
                    container.appendChild(toast);
                    showToast(toast);
                }
                trigger.remove();
            });

            // 2. MODALE
            let formToDelete = null;
            const modal = document.getElementById('stela-delete-modal');
            const modalBackdrop = modal.querySelector('.modal-backdrop');
            const modalPanel = modal.querySelector('.modal-panel');
            const cancelBtn = document.getElementById('cancel-delete');
            const confirmBtn = document.getElementById('confirm-delete');

            const openModal = () => {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => {
                    modalBackdrop.classList.remove('opacity-0');
                    modalPanel.classList.remove('opacity-0', 'scale-95');
                    modalPanel.classList.add('scale-100');
                }, 10);
            };

            const closeModal = () => {
                modalBackdrop.classList.add('opacity-0');
                modalPanel.classList.remove('scale-100');
                modalPanel.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    formToDelete = null;
                }, 300);
            };

            document.querySelectorAll('.delete-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    formToDelete = this;
                    openModal();
                });
            });

            confirmBtn.addEventListener('click', () => {
                if(formToDelete) formToDelete.submit();
            });

            cancelBtn.addEventListener('click', closeModal);
            modalBackdrop.addEventListener('click', closeModal);

            // 3. LIKES & VUES
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault(); e.stopPropagation();
                    const url = this.dataset.url;
                    const countSpan = this.querySelector('.like-count');
                    const icon = this.querySelector('.like-icon');
                    this.style.transform = "scale(0.8)";
                    setTimeout(() => this.style.transform = "scale(1)", 150);

                    fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                        .then(r => r.json())
                        .then(data => {
                            if(countSpan) countSpan.textContent = data.likes;
                            if (data.message !== 'added') {
                                this.classList.remove('text-[#c5a059]');
                                this.classList.add('text-[#78716c]');
                                if (icon) icon.setAttribute('fill', 'none');
                            } else {
                                this.classList.add('text-[#c5a059]');
                                this.classList.remove('text-[#78716c]');
                                if (icon) icon.setAttribute('fill', 'currentColor');
                            }
                        })
                        .catch(err => console.error("Erreur Like:", err));
                });
            });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const card = entry.target;
                        const viewUrl = card.dataset.viewUrl;

                        if (!card.dataset.viewed && viewUrl) {
                            card.dataset.viewed = "true";
                            fetch(viewUrl, { method: 'POST' });
                        }
                    }
                });
            }, { threshold: 0.6 });
            document.querySelectorAll('.tweet-card').forEach(card => observer.observe(card));
        });
    </script>
{% endblock %}
