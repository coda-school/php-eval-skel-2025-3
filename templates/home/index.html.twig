{% extends '_layouts/in_app.html.twig' %}
{% import '_macros/tweet.html.twig' as macros %}

{% block title %}{{ 'menu.sanctuary'|trans({}, 'stela') }} - STELA{% endblock %}

{% block content %}
    <div class="sticky top-0 z-40 bg-[#0c0a09]/80 backdrop-blur-md border-b border-[#292524] p-4 block lg:hidden">
        <h2 class="font-cinzel font-bold text-[#c5a059] text-xl">{{ 'title'|trans({}, 'stela') }}</h2>
    </div>

    {% if form is defined and form %}
        <div class="border-b border-[#292524] p-4 bg-[#0c0a09]/50 backdrop-blur-sm">
            {{ form_start(form) }}

            {# GESTION ERREURS #}
            {% if form.content.vars.errors|length > 0 %}
                {% for error in form.content.vars.errors %}
                    <div class="stela-flash-trigger" data-type="error" data-message="{{ error.message }}"></div>
                {% endfor %}
            {% endif %}
            {% if form.vars.errors|length > 0 %}
                {% for error in form.vars.errors %}
                    <div class="stela-flash-trigger" data-type="error" data-message="{{ error.message }}"></div>
                {% endfor %}
            {% endif %}
            {% if form.imageFile.vars.errors|length > 0 %}
                {% for error in form.imageFile.vars.errors %}
                    <div class="stela-flash-trigger" data-type="error" data-message="{{ error.message }}"></div>
                {% endfor %}
            {% endif %}

            <div class="flex gap-4">
                <div class="w-10 h-10 rounded-full bg-[#292524] flex items-center justify-center text-[#57534e] flex-shrink-0 overflow-hidden border border-[#44403c]">
                    {% if app.user and app.user.avatar %}
                        <img src="{{ asset(app.user.avatar) }}" class="w-full h-full object-cover">
                    {% elseif app.user %}
                        <span class="font-bold">{{ app.user.username|slice(0,1)|upper }}</span>
                    {% else %}
                        ?
                    {% endif %}
                </div>

                <div class="flex-grow pt-2">
                    {{ form_widget(form.content, {
                        'attr': {
                            'id': 'tweet-content',
                            'oninput': 'updateTweetStats(this)',
                            'class': 'w-full bg-transparent text-[#e7e5e4] placeholder-[#57534e] text-lg resize-none focus:outline-none overflow-hidden box-border py-2 min-h-[3rem]',
                            'rows': '1',
                            'placeholder': 'tweet.placeholder'|trans({}, 'stela')
                        }
                    }) }}

                    <div class="flex justify-end items-start mt-1">
                        <div id="char-counter"
                             class="text-[10px] text-[#57534e] font-mono tracking-widest transition-colors">0/280
                        </div>
                    </div>

                    <div id="home-image-preview-container" class="hidden mt-4 relative w-fit group">
                        <img id="home-image-preview" src=""
                             class="rounded-xl max-h-64 border border-[#292524] shadow-lg object-cover">
                        <button type="button" id="home-remove-image-btn"
                                class="absolute top-2 right-2 bg-black/70 text-white rounded-full p-1 hover:bg-black transition backdrop-blur-sm"
                                title="{{ 'tweet.actions.remove_image'|trans({}, 'stela') }}">
                            ✕
                        </button>
                    </div>

                    <div class="flex items-center justify-between mt-4 border-t border-[#292524] pt-3">
                        <div class="flex gap-2 text-[#c5a059]">
                            <label for="{{ form.imageFile.vars.id }}"
                                   class="cursor-pointer p-2 rounded-full hover:bg-[#c5a059]/10 transition active:scale-90"
                                   title="{{ 'tweet.actions.add_image'|trans({}, 'stela') }}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </label>
                            {{ form_widget(form.imageFile, {'attr': {'class': 'hidden', 'onchange': 'previewHomeImage(event)'}}) }}
                        </div>

                        <button type="submit"
                                class="bg-[#c5a059] hover:bg-[#b59049] text-[#0c0a09] font-bold py-1.5 px-5 rounded-full transition font-cinzel text-sm uppercase tracking-wide disabled:opacity-50">
                            {{ 'tweet.actions.engrave'|trans({}, 'stela') }}
                        </button>
                    </div>
                </div>
            </div>
            {{ form_end(form) }}
        </div>
    {% endif %}

    <div class="pb-20">
        {% for tweet in tweets %}
            {{ macros.tweet_card(tweet, app) }}
        {% else %}
            <div class="p-10 text-center border-t border-[#292524]">
                <p class="text-[#57534e] font-serif italic text-lg">{{ 'tweet.nothing'|trans({}, 'stela') }}</p>
            </div>
        {% endfor %}

        {# --- PAGINATION --- #}
        {% if tweets.getTotalItemCount > 0 %}
            <div class="flex justify-center items-center gap-6 py-8 border-t border-[#292524] mt-4">
                {% if tweets.currentPageNumber > 1 %}
                    <a href="{{ path(app.request.attributes.get('_route'), app.request.attributes.get('_route_params')|merge(app.request.query.all|merge({'page': tweets.currentPageNumber - 1}))) }}"
                       class="flex items-center gap-2 px-4 py-2 rounded-full border border-[#44403c] text-[#e7e5e4] hover:border-[#c5a059] hover:text-[#c5a059] transition font-cinzel text-xs font-bold uppercase tracking-wider bg-[#0c0a09]">
                        <span>←</span>
                        <span>Précédent</span>
                    </a>
                {% endif %}

                <span class="text-[#57534e] text-xs font-mono tracking-widest">
                    Page {{ tweets.currentPageNumber }} / {{ tweets.pageCount }}
                </span>

                {% if tweets.currentPageNumber < tweets.pageCount %}
                    <a href="{{ path(app.request.attributes.get('_route'), app.request.attributes.get('_route_params')|merge(app.request.query.all|merge({'page': tweets.currentPageNumber + 1}))) }}"
                       class="flex items-center gap-2 px-4 py-2 rounded-full border border-[#44403c] text-[#e7e5e4] hover:border-[#c5a059] hover:text-[#c5a059] transition font-cinzel text-xs font-bold uppercase tracking-wider bg-[#0c0a09]">
                        <span>Suivant</span>
                        <span>→</span>
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.like-btn');
            if (!btn) return;

            e.preventDefault();
            e.stopPropagation();

            const url = btn.dataset.url;
            const icon = btn.querySelector('.like-icon');
            const countSpan = btn.querySelector('.like-count');

            const titleLike = btn.dataset.titleLike;
            const titleUnlike = btn.dataset.titleUnlike;

            fetch(url, {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
                .then(res => res.json())
                .then(data => {
                    countSpan.textContent = data.likes > 0 ? data.likes : '';
                    if (data.likes > 0) countSpan.classList.add('font-bold');
                    else countSpan.classList.remove('font-bold');

                    if (data.message === 'added') {
                        icon.setAttribute('fill', 'currentColor');
                        btn.classList.remove('text-[#78716c]', 'hover:text-[#c5a059]');
                        btn.classList.add('text-[#c5a059]');
                        btn.setAttribute('title', titleUnlike);
                    } else {
                        icon.setAttribute('fill', 'none');
                        btn.classList.remove('text-[#c5a059]');
                        btn.classList.add('text-[#78716c]', 'hover:text-[#c5a059]');
                        btn.setAttribute('title', titleLike);
                    }
                })
                .catch(err => console.error('Erreur Like:', err));
        });

        window.updateTweetStats = function (textarea) {
            const counter = document.getElementById('char-counter');
            const maxLength = 280;
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            if (counter) {
                const currentLength = textarea.value.length;
                counter.textContent = `${currentLength}/${maxLength}`;
                if (currentLength >= maxLength) {
                    counter.classList.remove('text-[#57534e]', 'text-orange-500');
                    counter.classList.add('text-red-500');
                } else if (currentLength > maxLength * 0.9) {
                    counter.classList.remove('text-[#57534e]', 'text-red-500');
                    counter.classList.add('text-orange-500');
                } else {
                    counter.classList.remove('text-red-500', 'text-orange-500');
                    counter.classList.add('text-[#57534e]');
                }
            }
        };

        window.previewHomeImage = function(event) {
            const input = event.target;
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('home-image-preview');
                    const container = document.getElementById('home-image-preview-container');
                    if (img && container) {
                        img.src = e.target.result;
                        container.classList.remove('hidden');
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const removeBtn = document.getElementById('home-remove-image-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function () {
                    const input = document.querySelector('input[name*="[imageFile]"]');
                    if (input) input.value = '';
                    document.getElementById('home-image-preview-container').classList.add('hidden');
                    document.getElementById('home-image-preview').src = '';
                });
            }
            const textarea = document.getElementById('tweet-content');
            if (textarea) {
                window.requestAnimationFrame(() => {
                    window.updateTweetStats(textarea);
                });
            }
        });
    </script>
{% endblock %}
