<style>
    .stela-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .stela-scrollbar::-webkit-scrollbar-track {
        background: #0c0a09;
        border-radius: 4px;
    }
    .stela-scrollbar::-webkit-scrollbar-thumb {
        background-color: #c5a059;
        border-radius: 4px;
        border: 1px solid #0c0a09;
    }
    .stela-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #eab308;
    }
    .stela-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #c5a059 #0c0a09;
    }
</style>

<div id="stela-fab"
     class="fixed bottom-6 right-6 z-50 cursor-pointer group transition-all duration-500 hover:scale-105">

    <div class="bg-[#0c0a09] border border-[#c5a059] text-[#c5a059] p-3 rounded-full shadow-[0_0_15px_rgba(197,160,89,0.3)] group-hover:shadow-[0_0_25px_rgba(197,160,89,0.6)] flex items-center justify-center transition-all relative overflow-hidden">
        <div class="absolute inset-0 bg-[#c5a059] opacity-0 group-hover:opacity-20 transition-opacity duration-500"></div>

        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="relative z-10">
            <path d="M12 2a10 10 0 1 0 10 10 10 10 0 0 0-10-10z" opacity="0.5"/>
            <path d="M12 6a6 6 0 1 0 6 6 6 6 0 0 0-6-6z"/>
            <path d="M12 12m-2 0a2 2 0 1 0 4 0a2 2 0 1 0-4 0"/>
            <path d="M12 2v4"/> <path d="M12 18v4"/>
            <path d="M2 12h4"/> <path d="M18 12h4"/>
        </svg>
    </div>

    <span class="absolute top-0 right-0 flex h-3 w-3 z-20">
      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#c5a059] opacity-75"></span>
      <span class="relative inline-flex rounded-full h-3 w-3 bg-[#c5a059] border border-[#0c0a09]"></span>
    </span>
</div>

<div id="stela-chat-window"
     class="fixed bottom-24 right-6 w-80 md:w-96 bg-[#0c0a09] border border-[#c5a059] rounded-xl shadow-[0_0_40px_rgba(0,0,0,0.9)] z-50 transform transition-all duration-300 translate-y-10 opacity-0 pointer-events-none hidden flex flex-col overflow-hidden font-serif">

    <div class="bg-[#1c1917] border-b border-[#c5a059]/30 p-4 flex justify-between items-center relative overflow-hidden shrink-0">
        <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/dark-leather.png')] pointer-events-none"></div>
        <div class="flex items-center gap-3 relative z-10">
            <div class="w-2 h-2 bg-[#c5a059] rounded-full animate-pulse shadow-[0_0_8px_#c5a059]"></div>
            <h3 class="font-bold text-[#c5a059] tracking-widest uppercase font-cinzel text-sm">L'Oracle</h3>
        </div>
        <button id="stela-close" class="text-[#78716c] hover:text-[#c5a059] transition relative z-10">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>
        </button>
    </div>

    <div id="stela-messages" style="max-height: 400px;" class="flex-1 p-4 overflow-y-auto h-72 bg-[#0c0a09] space-y-4 text-sm relative stela-scrollbar">

        <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/dark-leather.png')] pointer-events-none fixed"></div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-[#c5a059]/10 via-transparent to-transparent pointer-events-none fixed"></div>

        <div class="flex items-start gap-3 relative z-10 animate-fade-in-up">
            <div class="w-8 h-8 rounded-full bg-[#1c1917] border border-[#c5a059] flex items-center justify-center text-[#c5a059] shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/><path d="M2 12h20"/></svg>
            </div>
            <div class="flex flex-col w-full max-w-[320px] leading-relaxed p-3 border border-[#c5a059]/50 bg-[#1c1917] rounded-r-lg rounded-bl-lg shadow-sm backdrop-blur-sm">
                <p class="text-[#e7e5e4] italic">Les étoiles t'observent. Quelle vérité cherches-tu à exhumer ?</p>
            </div>
        </div>
    </div>

    <div class="p-3 bg-[#1c1917] border-t border-[#c5a059]/30 relative z-10 shrink-0">
        <form id="stela-form" class="flex gap-2 relative" data-url="{{ path('api_stela_bot_chat') }}">
            <input type="text" id="stela-input"
                   class="flex-1 bg-[#0c0a09] border border-[#c5a059]/50 text-[#e7e5e4] text-sm rounded-lg focus:ring-1 focus:ring-[#c5a059] focus:border-[#c5a059] block w-full p-3 pl-4 placeholder-[#78716c] outline-none font-serif transition-colors shadow-inner"
                   placeholder="Inscris ta requête..." required autocomplete="off">
            <button type="submit" class="p-3 text-[#0c0a09] bg-[#c5a059] hover:bg-[#b59049] rounded-lg transition-all shadow-[0_0_10px_rgba(197,160,89,0.2)] hover:shadow-[0_0_15px_rgba(197,160,89,0.4)] active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
            </button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fab = document.getElementById('stela-fab');
        const chatWindow = document.getElementById('stela-chat-window');
        const closeBtn = document.getElementById('stela-close');
        const form = document.getElementById('stela-form');
        const input = document.getElementById('stela-input');
        const messagesContainer = document.getElementById('stela-messages');

        let isOpen = false;

        function toggleChat() {
            isOpen = !isOpen;
            if (isOpen) {
                chatWindow.classList.remove('hidden');
                setTimeout(() => {
                    chatWindow.classList.remove('translate-y-10', 'opacity-0', 'pointer-events-none');
                }, 10);
                input.focus();
                scrollToBottom();
            } else {
                chatWindow.classList.add('translate-y-10', 'opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    chatWindow.classList.add('hidden');
                }, 300);
            }
        }

        document.addEventListener('click', (event) => {
            if (isOpen) {
                const isClickInsideChat = chatWindow.contains(event.target);
                const isClickOnFab = fab.contains(event.target);

                if (!isClickInsideChat && !isClickOnFab) {
                    toggleChat();
                }
            }
        });

        fab.addEventListener('click', toggleChat);
        closeBtn.addEventListener('click', toggleChat);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userText = input.value.trim();
            if (!userText) return;

            const apiUrl = form.dataset.url;
            addMessage(userText, 'user');
            input.value = '';
            const typingId = addTypingIndicator();

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: JSON.stringify({ message: userText })
                });

                if (!response.ok) throw new Error('Erreur');
                const data = await response.json();
                removeMessage(typingId);
                addMessage(data.response, 'bot');
            } catch (error) {
                removeMessage(typingId);
                addMessage("Le lien avec l'au-delà est rompu...", 'bot');
            }
        });

        function addMessage(text, sender) {
            const isUser = sender === 'user';
            const div = document.createElement('div');
            div.className = `flex items-start gap-3 relative z-10 animate-fade-in-up ${isUser ? 'flex-row-reverse' : ''}`;

            const avatar = isUser
                ? `<div class="w-8 h-8 rounded-full bg-[#292524] border border-[#44403c] flex items-center justify-center text-[#78716c] shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>`
                : `<div class="w-8 h-8 rounded-full bg-[#1c1917] border border-[#c5a059] flex items-center justify-center text-[#c5a059] shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/><path d="M2 12h20"/></svg></div>`;

            const bubbleClass = isUser
                ? 'bg-[#c5a059] text-[#0c0a09] font-bold rounded-l-lg rounded-br-lg shadow-[0_0_10px_rgba(197,160,89,0.2)]'
                : 'bg-[#1c1917]/90 border border-[#c5a059]/50 text-[#e7e5e4] rounded-r-lg rounded-bl-lg italic backdrop-blur-sm';

            div.innerHTML = `
                ${avatar}
                <div class="flex flex-col w-full max-w-[320px] leading-relaxed p-3 ${bubbleClass}">
                    <p class="text-sm">${text}</p>
                </div>
            `;
            messagesContainer.appendChild(div);
            scrollToBottom();
            return div.id = 'msg-' + Date.now();
        }

        function addTypingIndicator() {
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start gap-3 relative z-10 animate-fade-in-up";
            div.innerHTML = `<div class="w-8 h-8 rounded-full bg-[#1c1917] border border-[#c5a059] flex items-center justify-center text-[#c5a059] shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/><path d="M2 12h20"/></svg></div><div class="flex items-center p-4 bg-[#1c1917] border border-[#c5a059]/30 rounded-r-lg rounded-bl-lg gap-2 h-10"><div class="w-1.5 h-1.5 bg-[#c5a059] rounded-full animate-bounce"></div><div class="w-1.5 h-1.5 bg-[#c5a059] rounded-full animate-bounce delay-75"></div><div class="w-1.5 h-1.5 bg-[#c5a059] rounded-full animate-bounce delay-150"></div></div>`;
            messagesContainer.appendChild(div);
            scrollToBottom();
            return id;
        }
        function removeMessage(id) { const el = document.getElementById(id); if (el) el.remove(); }
        function scrollToBottom() { messagesContainer.scrollTop = messagesContainer.scrollHeight; }
    });
</script>
