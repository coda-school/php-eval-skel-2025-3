{% extends 'base.html.twig' %}

{% block title %}Prêter Serment - STELA{% endblock %}

{#
============================================================================
THEME DES ERREURS
Surcharge locale pour afficher les erreurs sous forme de liste stylisée
============================================================================
#}
{% form_theme registrationForm _self %}

{% block form_errors %}
    {% if errors|length > 0 %}
        <div class="stela-errors-wrapper animate-pulse">
            <div class="stela-error-list">
                {% for error in errors %}
                    <div class="stela-error-item">
                        <span class="stela-error-bullet">✦</span>
                        <span class="flex-1 font-serif italic">{{ error.message|striptags|raw }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block body %}
    <div class="min-h-screen flex items-center justify-center py-12 px-4 stela-bg font-serif relative overflow-hidden">

        {# Conteneur Principal : La Dalle #}
        <div class="stela-slab safari-fix {% if not registrationForm.vars.valid %}stela-shake{% endif %}">

            {# Texture de fond (Cuir/Pierre) #}
            <div class="stela-texture"></div>

            <div class="relative z-10 p-8 border border-[#c5a059]/10 h-full flex flex-col">

                {# En-tête : Titre et Sous-titre #}
                <div class="text-center mb-10 space-y-3">
                    <h1 class="text-5xl text-[#c5a059] uppercase tracking-[0.3em] font-bold pl-4 font-cinzel" style="text-shadow: 0 4px 10px rgba(0,0,0,0.8);">
                        Stela
                    </h1>
                    <div class="h-[1px] w-32 bg-gradient-to-r from-transparent via-[#c5a059]/70 to-transparent mx-auto"></div>
                    <p class="text-[#8c7b6c] text-xs uppercase tracking-[0.2em] pt-2 font-bold">
                        {{ 'security.subtitle'|trans({}, 'stela') }}
                    </p>
                </div>

                {{ form_start(registrationForm, {'attr': {'class': 'space-y-6 flex-grow', 'novalidate': 'novalidate'}}) }}

                {#
                =========================
                CHAMP : ÉPONYME (User)
                =========================
                #}
                <div class="stela-group group">
                    <label for="{{ registrationForm.username.vars.id }}" class="stela-label">{{ 'security.fields.username'|trans({}, 'stela') }}</label>
                    <div class="stela-input-groove">
                        <span class="absolute left-3 top-3 text-[#57534e] select-none font-serif text-xl">@</span>
                        {{ form_widget(registrationForm.username, { 'attr': { 'class': 'stela-input pl-9' } }) }}
                        <span id="bar-username" class="stela-bar"></span>
                    </div>
                    {{ form_errors(registrationForm.username) }}
                </div>

                {#
                =========================
                CHAMP : HIBOURIEL (Email)
                =========================
                #}
                <div class="stela-group group">
                    <label for="{{ registrationForm.email.vars.id }}" class="stela-label">{{ 'security.fields.email'|trans({}, 'stela') }}</label>
                    <div class="stela-input-groove">
                        {{ form_widget(registrationForm.email, { 'attr': { 'class': 'stela-input' } }) }}
                        <span id="bar-email" class="stela-bar"></span>
                    </div>
                    {{ form_errors(registrationForm.email) }}
                </div>

                {#
                =========================
                CHAMP : SCEAU SECRET (Password)
                =========================
                #}
                <div class="stela-group group">
                    <label for="{{ registrationForm.plainPassword.vars.id }}" class="stela-label">{{ 'security.fields.password'|trans({}, 'stela') }}</label>
                    <div class="stela-input-groove">
                        {# Note: 'is-hidden-dots' applique l'espacement large pour les points #}
                        {{ form_widget(registrationForm.plainPassword, { 'attr': { 'class': 'stela-input pr-12 stela-input-password is-hidden-dots', 'placeholder': '••••••••••••' }}) }}

                        <button type="button" id="toggle-password">
                            <svg id="eye-closed" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                            <svg id="eye-open" class="hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                        </button>
                        <span id="bar-password" class="stela-bar"></span>
                    </div>

                    {{ form_errors(registrationForm.plainPassword) }}

                    {# Jauge de force #}
                    <div class="strength-meter mt-3">
                        <div class="strength-bar" id="strength-bar"></div>
                    </div>

                    {# Critères de validation #}
                    <div id="password-criteria" class="flex flex-wrap gap-x-4 gap-y-2 mt-3 pl-1">
                        <span class="badge" data-requirement="length">{{ 'security.checklist.check1'|trans({}, 'stela') }}</span>
                        <span class="badge" data-requirement="lowercase">{{ 'security.checklist.check2'|trans({}, 'stela') }}</span>
                        <span class="badge" data-requirement="uppercase">{{ 'security.checklist.check3'|trans({}, 'stela') }}</span>
                        <span class="badge" data-requirement="number">{{ 'security.checklist.check4'|trans({}, 'stela') }}</span>
                        <span class="badge" data-requirement="special">{{ 'security.checklist.check5'|trans({}, 'stela') }}</span>
                    </div>
                </div>

                {#
                =========================
                CHAMP : RITUEL (Terms)
                =========================
                #}
                <div class="stela-group pt-2">
                    <label for="{{ registrationForm.agreeTerms.vars.id }}" class="stela-check-container group">
                        {{ form_widget(registrationForm.agreeTerms, {'attr': {'class': 'hidden'}}) }}

                        {# La classe 'invalid' ajoute une bordure rouge si erreur #}
                        <div class="stela-checkbox {% if not registrationForm.agreeTerms.vars.valid %}invalid{% endif %}">
                            <div class="stela-checkmark" id="check-mark"></div>
                        </div>

                        <div class="ml-6 text-sm text-[#78716c] leading-tight group-hover:text-[#a8a29e]">
                            <span class="block text-[10px] uppercase tracking-widest text-[#c5a059]/70 font-bold mb-1">{{ 'security.terms.title'|trans({}, 'stela') }}</span>
                            {{ 'security.terms.text'|trans({}, 'stela') }}
                        </div>
                    </label>
                    {{ form_errors(registrationForm.agreeTerms) }}
                </div>

                {# Bouton de Soumission #}
                <button type="submit" class="stela-btn-original group safari-fix">
                    <span class="stela-btn-line top"></span>
                    <span class="stela-btn-shadow"></span>
                    <span class="stela-btn-content">
                        <span class="stela-btn-decor">- ⌬ -</span>
                        <span class="stela-btn-text">{{ 'security.buttons.register'|trans({}, 'stela') }}</span>
                        <span class="stela-btn-decor">- ⌬ -</span>
                    </span>
                    <span class="stela-btn-glow"></span>
                    <span class="stela-btn-click"></span>
                    <span class="stela-btn-line bottom"></span>
                </button>

                {{ form_end(registrationForm) }}

                {# Pied de page : Lien Login #}
                <div class="stela-link-container">
                    <div class="stela-link-line"></div>
                    <p class="text-[#78716c] text-[10px] uppercase tracking-[0.25em] mb-4 font-bold mt-4">{{ 'security.links.already_member'|trans({}, 'stela') }}</p>
                    <a href="{{ path('app_login', {'_locale': app.request.locale}) }}" class="stela-link group">
                        <span class="stela-link-arrow left">►</span>
                        <span class="stela-link-text">
                            {{ 'security.buttons.login'|trans({}, 'stela') }}
                            <span class="stela-link-underline"></span>
                        </span>
                        <span class="stela-link-arrow right">◄</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            /* =========================================
               1. GESTION DES BARRES DE VALIDATION
               (Souligne l'input en Or ou Rouge)
               ========================================= */
            const fields = [
                { input: document.getElementById('{{ registrationForm.username.vars.id }}'), bar: document.getElementById('bar-username'), regex: /^.{3,20}$/ },
                { input: document.getElementById('{{ registrationForm.email.vars.id }}'), bar: document.getElementById('bar-email'), regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ },
                { input: document.getElementById('{{ registrationForm.plainPassword.vars.id }}'), bar: document.getElementById('bar-password'), regex: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/ }
            ];

            function updateBar(item) {
                if (!item.input || !item.bar) return;

                const val = item.input.value;
                const isValid = item.regex.test(val);
                const isTouched = val.length > 0;

                // Au chargement initial : si le champ est vide et valide (pas d'erreur serveur), on cache la barre.
                {% if registrationForm.vars.valid %}
                if (!isTouched) {
                    item.bar.style.opacity = '0';
                    return;
                }
                {% endif %}

                // Affichage de la barre
                item.bar.style.opacity = '1';
                if (isValid) {
                    item.bar.classList.add('valid');
                    item.bar.classList.remove('invalid');
                } else {
                    item.bar.classList.add('invalid');
                    item.bar.classList.remove('valid');
                }
            }

            // Initialisation des écouteurs
            fields.forEach(item => {
                if(item.input) {
                    updateBar(item); // État initial
                    item.input.addEventListener('input', () => updateBar(item));
                }
            });

            /* =========================================
               2. ANALYSE DU MOT DE PASSE
               (Mise à jour de la jauge et des badges)
               ========================================= */
            const passwordInput = document.getElementById('{{ registrationForm.plainPassword.vars.id }}');
            const criteriaList = document.querySelectorAll('#password-criteria .badge');
            const strengthBar = document.getElementById('strength-bar');

            const pwReqs = {
                length: /^.{8,}$/,
                lowercase: /[a-z]/,
                uppercase: /[A-Z]/,
                number: /[0-9]/,
                special: /[\W_]/
            };

            function updatePasswordUI() {
                const val = passwordInput.value;
                let count = 0;

                // Vérification de chaque critère
                criteriaList.forEach(item => {
                    const reqType = item.dataset.requirement;
                    const isValid = pwReqs[reqType].test(val);

                    item.classList.toggle('valid', isValid);
                    if (isValid) count++;
                });

                // Mise à jour de la jauge (20% par critère)
                strengthBar.style.width = (count * 20) + '%';

                // Code couleur de la jauge
                if (count <= 2) strengthBar.style.backgroundColor = '#ef4444'; // Rouge
                else if (count < 5) strengthBar.style.backgroundColor = '#f59e0b'; // Orange
                else strengthBar.style.backgroundColor = '#c5a059'; // Or (Succès)
            }

            if (passwordInput) {
                passwordInput.addEventListener('input', updatePasswordUI);
                updatePasswordUI();
            }

            /* =========================================
               3. CHECKBOX "RITUEL"
               (Synchronisation visuelle custom)
               ========================================= */
            const termsInput = document.getElementById('{{ registrationForm.agreeTerms.vars.id }}');
            const checkMark = document.getElementById('check-mark');
            const checkboxContainer = document.querySelector('.stela-checkbox');

            const updateCheck = () => {
                // Affiche ou cache la coche dorée
                checkMark.style.opacity = termsInput.checked ? '1' : '0';

                // Si l'utilisateur coche la case, on retire la bordure rouge d'erreur
                if (termsInput.checked && checkboxContainer) {
                    checkboxContainer.classList.remove('invalid');
                }
            };

            if (termsInput) {
                updateCheck();
                termsInput.addEventListener('change', updateCheck);
            }

            /* =========================================
               4. VISIBILITÉ DU MOT DE PASSE
               (Toggle Text/Password + Spacing)
               ========================================= */
            const toggleBtn = document.getElementById('toggle-password');
            const eyeOpen = document.getElementById('eye-open');
            const eyeClosed = document.getElementById('eye-closed');

            if (toggleBtn && passwordInput) {
                toggleBtn.addEventListener('click', () => {
                    const isPasswordType = passwordInput.type === 'password';

                    // Bascule Input Type
                    passwordInput.type = isPasswordType ? 'text' : 'password';

                    // Bascule Classe CSS (Spacing des points)
                    // Si on repasse en password, on remet les points espacés
                    if (passwordInput.type === 'password') {
                        passwordInput.classList.add('is-hidden-dots');
                    } else {
                        passwordInput.classList.remove('is-hidden-dots');
                    }

                    // Bascule Icônes
                    eyeOpen.classList.toggle('hidden', !isPasswordType);
                    eyeClosed.classList.toggle('hidden', isPasswordType);
                });
            }
        });
    </script>
{% endblock %}
