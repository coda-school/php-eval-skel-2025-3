{% extends '_layouts/in_app.html.twig' %}

{# --- CONFIGURATION --- #}
{% set hide_sidebar_right = true %}

{% block title %}{{ 'settings.title'|trans({}, 'stela') }} - STELA{% endblock %}

{# --- STYLES & FIX OS --- #}
{% block stylesheets %}
    {{ parent() }}
    <style>
        textarea.stela-input { resize: none; }

        select.stela-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: transparent;
            color: #e7e5e4;
            cursor: pointer;
            padding-right: 2.5rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2378716c' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }

        /* Fix Fond/Texte Options (Linux/Windows) */
        select.stela-select option {
            background-color: #0c0a09;
            color: #e7e5e4;
            padding: 10px;
        }
    </style>
{% endblock %}

{# --- THEME FORMULAIRE --- #}
{% form_theme form _self %}

{% block form_errors %}
    {% if errors|length > 0 %}
        <div class="stela-errors-wrapper mt-2">
            <div class="flex flex-col gap-1">
                {% for error in errors %}
                    <div class="flex items-start gap-2 text-[#ef4444] text-[10px] font-bold uppercase tracking-widest animate-pulse">
                        <span class="text-[#c5a059]">✦</span>
                        <span>{{ error.message }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block content %}
    <div class="min-h-screen stela-bg flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 w-full">

        <div class="stela-slab p-8 sm:p-12 relative overflow-hidden w-full max-w-4xl mx-auto">
            <div class="stela-texture"></div>

            {# --- HEADER --- #}
            <div class="relative z-10 mb-10 text-center border-b border-[#292524] pb-6">
                <h1 class="text-3xl font-cinzel text-[#e7e5e4] tracking-widest font-bold mb-2">
                    {{ 'settings.title'|trans({}, 'stela') }}
                </h1>
                <p class="text-[#78716c] text-xs uppercase tracking-[0.2em]">
                    {{ 'settings.subtitle'|trans({}, 'stela') }}
                </p>
            </div>

            {{ form_start(form, {'attr': {'class': 'relative z-10', 'id': 'settings-form'}}) }}

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 relative">

                {# --- COLONNE GAUCHE : IDENTITE --- #}
                <div class="space-y-8">

                    {# Avatar #}
                    <div class="text-center">
                        <div class="relative inline-block group">
                            <div class="h-24 w-24 rounded-full p-1 border border-[#292524] bg-[#0c0a09] shadow-2xl mx-auto overflow-hidden relative flex items-center justify-center">
                                <img id="avatar-preview"
                                     class="h-full w-full rounded-full object-cover absolute inset-0 z-20 transition-opacity duration-500 {{ app.user.avatar ? 'opacity-80 group-hover:opacity-100' : 'hidden' }}"
                                     src="{{ app.user.avatar ? asset(app.user.avatar) : '' }}" alt="Avatar">
                                <div id="avatar-placeholder" class="h-full w-full rounded-full bg-[#1c1917] flex items-center justify-center text-[#44403c] absolute inset-0 z-10 {{ app.user.avatar ? 'hidden' : '' }}">
                                    <span class="font-cinzel text-2xl font-bold">{{ app.user.username|slice(0,1)|upper }}</span>
                                </div>
                            </div>
                            <label for="{{ form.avatarFile.vars.id }}" class="mt-4 inline-block cursor-pointer">
                                <span class="stela-link-text text-[10px] text-[#78716c] hover:text-[#c5a059] transition-colors border-b border-[#292524] hover:border-[#c5a059] pb-1">
                                    {{ 'fields.avatar'|trans({}, 'stela') }}
                                </span>
                                {{ form_widget(form.avatarFile, {'attr': {'class': 'hidden', 'onchange': 'previewAvatar(event)'}}) }}
                            </label>
                            <div class="text-center mt-2">{{ form_errors(form.avatarFile) }}</div>
                        </div>
                    </div>

                    {# Inputs Texte #}
                    <div class="space-y-6">
                        <div class="stela-group">
                            {{ form_label(form.displayName, null, {'label_attr': {'class': 'stela-label'}}) }}
                            <div class="stela-input-groove">
                                {{ form_widget(form.displayName, {'attr': {'class': 'stela-input', 'maxlength': '30', 'placeholder': app.user.username }, 'translation_domain': false}) }}
                                <div class="stela-bar"></div>
                            </div>
                            {{ form_errors(form.displayName) }}
                        </div>

                        <div class="stela-group">
                            {{ form_label(form.username, null, {'label_attr': {'class': 'stela-label'}}) }}
                            <div class="stela-input-groove">
                                {{ form_widget(form.username, {'attr': {'class': 'stela-input', 'maxlength': '30'}, 'translation_domain': false}) }}
                                <div class="stela-bar"></div>
                            </div>
                            {{ form_errors(form.username) }}
                        </div>

                        <div class="stela-group">
                            {{ form_label(form.bio, null, {'label_attr': {'class': 'stela-label'}}) }}
                            <div class="stela-input-groove relative">
                                {{ form_widget(form.bio, {'attr': {'class': 'stela-input', 'rows': 5, 'maxlength': '160', 'placeholder': '...'}, 'translation_domain': false}) }}
                                <div class="stela-bar"></div>
                                <div id="bio-counter" class="absolute bottom-1 right-2 text-[10px] text-[#44403c] font-bold font-mono transition-colors duration-300">0/160</div>
                            </div>
                            {{ form_errors(form.bio) }}
                        </div>
                    </div>
                </div>

                {# Séparateur #}
                <div class="hidden lg:block absolute left-1/2 top-0 bottom-0 w-px bg-gradient-to-b from-transparent via-[#292524] to-transparent -translate-x-1/2"></div>

                {# --- COLONNE DROITE : PREFERENCES --- #}
                <div class="flex flex-col justify-between space-y-8">

                    <div class="space-y-8">
                        <h3 class="font-cinzel text-[#c5a059] text-left text-sm tracking-widest border-b border-[#292524] pb-2 w-fit pr-8">
                            {{ 'settings.preferences_title'|trans({}, 'stela') }}
                        </h3>

                        {# Selecteurs #}
                        <div class="grid grid-cols-1 gap-6">
                            <div class="stela-group">
                                {{ form_label(form.theme, null, {'label_attr': {'class': 'stela-label'}}) }}
                                <div class="stela-input-groove">
                                    {{ form_widget(form.theme, {'attr': {'class': 'stela-input stela-select'}}) }}
                                    <div class="stela-bar"></div>
                                </div>
                            </div>
                            <div class="stela-group">
                                {{ form_label(form.language, null, {'label_attr': {'class': 'stela-label'}}) }}
                                <div class="stela-input-groove">
                                    {{ form_widget(form.language, {'attr': {'class': 'stela-input stela-select'}}) }}
                                    <div class="stela-bar"></div>
                                </div>
                            </div>
                        </div>

                        {# Checkboxes #}
                        <div class="space-y-6 pt-2 bg-[#0c0a09]/50 p-6 rounded-lg border border-[#292524]">
                            <label class="stela-check-container group">
                                {{ form_widget(form.notificationsEnabled, {'attr': {'class': 'hidden peer'}}) }}
                                <div class="stela-checkbox peer-checked:border-[#c5a059] group-hover:border-[#c5a059]">
                                    <div class="stela-checkmark peer-checked:opacity-100"></div>
                                </div>
                                <div class="ml-4">
                                    <span class="stela-label !mb-0 cursor-pointer group-hover:text-[#c5a059] block">
                                         {{ 'settings.notifications'|trans({}, 'stela') }}
                                    </span>
                                    <span class="text-[10px] text-[#57534e] block mt-1">Recevoir les alertes rituelles</span>
                                </div>
                            </label>

                            <label class="stela-check-container group">
                                {{ form_widget(form.isPrivateAccount, {'attr': {'class': 'hidden peer'}}) }}
                                <div class="stela-checkbox peer-checked:border-[#c5a059] group-hover:border-[#c5a059]">
                                    <div class="stela-checkmark peer-checked:opacity-100"></div>
                                </div>
                                <div class="ml-4">
                                    <span class="stela-label !mb-0 cursor-pointer group-hover:text-[#c5a059] block">
                                        {{ 'settings.private_account'|trans({}, 'stela') }}
                                    </span>
                                    <span class="text-[10px] text-[#57534e] block mt-1">Seuls les initiés verront vos stèles</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    {# Bouton Action #}
                    <div class="pt-6 mt-auto">
                        <button type="submit" class="stela-btn-original group">
                            <div class="stela-btn-shadow"></div>
                            <div class="stela-btn-line top"></div>
                            <div class="stela-btn-line bottom"></div>
                            <div class="stela-btn-content">
                                <span class="stela-btn-text">{{ 'buttons.save'|trans({}, 'stela') }}</span>
                                <span class="stela-btn-decor">✦</span>
                            </div>
                            <div class="stela-btn-glow"></div>
                            <div class="stela-btn-click"></div>
                        </button>
                    </div>
                </div>
            </div>

            {{ form_end(form) }}
        </div>
    </div>

    {# --- SCRIPT --- #}
    <script>
        function previewAvatar(event) {
            const input = event.target;
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('avatar-preview');
                    const placeholder = document.getElementById('avatar-placeholder');
                    if(img) { img.src = e.target.result; img.classList.remove('hidden'); img.classList.add('opacity-100'); }
                    if(placeholder) { placeholder.classList.add('hidden'); }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('.stela-input');
            inputs.forEach(input => {
                const bar = input.nextElementSibling;
                input.addEventListener('focus', () => { if (bar) bar.classList.add('valid'); });
                input.addEventListener('blur', () => { if (bar) bar.classList.remove('valid'); });
            });

            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(chk => {
                const updateCheck = () => {
                    const visualMark = chk.nextElementSibling.querySelector('.stela-checkmark');
                    if (visualMark) visualMark.style.opacity = chk.checked ? '1' : '0';
                    const visualBox = chk.nextElementSibling;
                    if (visualBox) visualBox.style.borderColor = chk.checked ? '#c5a059' : '';
                };
                chk.addEventListener('change', updateCheck);
                updateCheck();
            });

            const bioInput = document.getElementById('{{ form.bio.vars.id }}');
            const bioCounter = document.getElementById('bio-counter');
            if (bioInput && bioCounter) {
                const maxLength = bioInput.getAttribute('maxlength') || 160;
                const updateCounter = () => {
                    const currentLength = bioInput.value.length;
                    bioCounter.textContent = `${currentLength}/${maxLength}`;
                    if (currentLength >= maxLength) { bioCounter.style.color = '#ef4444'; }
                    else if (currentLength > (maxLength * 0.9)) { bioCounter.style.color = '#fb923c'; }
                    else { bioCounter.style.color = '#44403c'; }
                };
                bioInput.addEventListener('input', updateCounter);
                updateCounter();
            }
        });
    </script>
{% endblock %}
