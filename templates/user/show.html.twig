{% extends '_layouts/in_app.html.twig' %}
{% import '_macros/tweet.html.twig' as macros %}

{% block title %}{{ 'tweet.page_title'|trans({'%username%': user.username}, 'stela') }} - STELA{% endblock %}

{% block content %}
    <div class="relative">
        {# Header Navigation (Retour) #}
        <div class="absolute top-0 left-0 p-4 z-20 flex items-center gap-6 bg-gradient-to-b from-black/80 to-transparent w-full">
            <a href="{{ path('app_home') }}" class="p-2 bg-black/50 rounded-full hover:bg-black/70 text-white transition backdrop-blur-md" title="{{ 'menu.sanctuary'|trans({}, 'stela') }}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            </a>
            <h2 class="font-bold text-lg font-cinzel text-white leading-none shadow-black drop-shadow-md">{{ user.username }}</h2>
        </div>

        {# Bannière #}
        <div class="h-48 w-full bg-[#1c1917] relative overflow-hidden border-b border-[#292524]">
            <div class="stela-texture opacity-40"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-[#0c0a09] to-transparent"></div>
        </div>

        <div class="px-4 pb-4 relative">
            {# Bloc Action (Suivre / Paramètres) #}
            <div class="absolute top-4 right-4 z-10">
                {% if app.user == user %}
                    <a href="{{ path('app_user_settings') }}" class="border border-[#44403c] text-[#e7e5e4] px-4 py-1.5 rounded-full text-sm font-bold hover:bg-[#292524] transition hover:border-[#c5a059]" title="{{ 'profile.actions.edit_profile'|trans({}, 'stela') }}">
                        {{ 'profile.actions.edit_profile'|trans({}, 'stela') }}
                    </a>
                {% else %}
                    <form action="{{ path('app_user_follow', {'userToFollow': user.id, '_locale': app.request.locale}) }}" method="POST">
                        {% if app.user in user.followers %}
                            <button type="submit" class="border border-[#44403c] text-[#e7e5e4] px-4 py-1.5 rounded-full text-sm font-bold hover:bg-red-900/20 hover:text-red-400 hover:border-red-900 transition group" title="{{ 'profile.actions.unfollow'|trans({}, 'stela') }}">
                                <span class="group-hover:hidden">{{ 'profile.actions.status_following'|trans({}, 'stela') }}</span>
                                <span class="hidden group-hover:inline">{{ 'profile.actions.unfollow'|trans({}, 'stela') }}</span>
                            </button>
                        {% else %}
                            <button type="submit" class="bg-[#e7e5e4] text-black px-4 py-1.5 rounded-full text-sm font-bold hover:bg-[#c5a059] transition" title="{{ 'profile.actions.follow'|trans({}, 'stela') }}">
                                {{ 'profile.actions.follow'|trans({}, 'stela') }}
                            </button>
                        {% endif %}
                    </form>
                {% endif %}
            </div>

            {# Avatar #}
            <div class="-mt-16 mb-3 relative inline-block">
                <div class="h-32 w-32 rounded-full p-1 bg-[#0c0a09] border border-[#c5a059] overflow-hidden shadow-2xl">
                    {% if user.avatar %}
                        <img src="{{ asset(user.avatar) }}" class="h-full w-full object-cover rounded-full" alt="{{ user.username }}">
                    {% else %}
                        <div class="h-full w-full bg-[#1c1917] flex items-center justify-center text-4xl text-[#c5a059] font-cinzel">
                            {{ user.username|slice(0,1)|upper }}
                        </div>
                    {% endif %}
                </div>
            </div>

            {# Infos #}
            <div>
                <h1 class="text-xl font-bold font-cinzel text-[#e7e5e4]">{{ user.getName() }}</h1>
                <p class="text-[#78716c] text-sm">@{{ user.username }}</p>
            </div>

            {# Bio #}
            {% if user.bio %}
                <p class="mt-4 text-[#d6d3d1] text-[15px] leading-relaxed max-w-md break-words">{{ user.bio }}</p>
            {% else %}
                <p class="mt-4 text-[#57534e] text-sm italic">{{ user.username }} {{ 'profile.bio.empty'|trans({}, 'stela') }}</p>
            {% endif %}

            {# Stats #}
            <div class="flex gap-4 mt-4 text-[#78716c] text-sm">
                <span class="hover:underline cursor-pointer"><strong class="text-[#e7e5e4]">{{ user.following|length }}</strong> {{ 'profile.subscriptions'|trans({}, 'stela') }}</span>
                <span class="hover:underline cursor-pointer"><strong class="text-[#e7e5e4]">{{ user.followers|length }}</strong> {{ 'profile.followers'|trans({}, 'stela') }}</span>
            </div>
        </div>

        {# --- ONGLETS (Switch JS) --- #}
        <div class="flex border-b border-[#292524] mt-2">
            <button onclick="switchTab('steles')" id="btn-steles" class="flex-1 text-center py-4 text-[#e7e5e4] font-bold text-sm border-b-2 border-[#c5a059] hover:bg-[#1c1917]/50 cursor-pointer transition">
                {{ 'profile.tabs.steles'|trans({}, 'stela') }}
            </button>
            <button onclick="switchTab('replies')" id="btn-replies" class="flex-1 text-center py-4 text-[#78716c] font-medium text-sm border-b-2 border-transparent hover:bg-[#1c1917]/50 cursor-pointer transition">
                {{ 'profile.tabs.replies'|trans({}, 'stela') }}
            </button>
        </div>
    </div>

    {# --- CONTENU DES ONGLETS --- #}
    <div class="pb-20">

        {# 1. ONGLET STÈLES (Tweets originaux) #}
        <div id="tab-content-steles">
            {# Filtre : seulement les tweets qui ne sont pas des réponses (n'ayant aucun tweet parent) #}
            {% set root_tweets = user.tweets|filter(t => t.parentTweet is null)|sort((a, b) => b.createdDate <=> a.createdDate) %}

            {% for tweet in root_tweets %}
                {{ macros.tweet_card(tweet, app) }}
            {% else %}
                <div class="p-10 text-center border-b border-[#292524]">
                    <p class="text-[#57534e] font-serif italic text-lg">{{ 'tweet.nothing'|trans({}, 'stela') }}</p>
                </div>
            {% endfor %}
        </div>

        {# ONGLET ANNOTATIONS #}
        <div id="tab-content-replies" class="hidden">
            {# Filtre : seulement les tweets qui sont des réponses (ayant un tweet parent) #}
            {% set replies = user.tweets|filter(t => t.parentTweet is not null)|sort((a, b) => b.createdDate <=> a.createdDate) %}

            {% for tweet in replies %}
                {{ macros.tweet_card(tweet, app) }}
            {% else %}
                <div class="p-10 text-center border-b border-[#292524]">
                    <p class="text-[#57534e] font-serif italic text-lg">{{ 'tweet.no_replies'|trans({}, 'stela') }}</p>
                </div>
            {% endfor %}
        </div>
    </div>

    {# --- SCRIPT --- #}
    <script>
        function switchTab(tabName) {
            const btnSteles = document.getElementById('btn-steles');
            const btnReplies = document.getElementById('btn-replies');
            const contentSteles = document.getElementById('tab-content-steles');
            const contentReplies = document.getElementById('tab-content-replies');

            if (tabName === 'steles') {
                btnSteles.className = "flex-1 text-center py-4 text-[#e7e5e4] font-bold text-sm border-b-2 border-[#c5a059] hover:bg-[#1c1917]/50 cursor-pointer transition";
                btnReplies.className = "flex-1 text-center py-4 text-[#78716c] font-medium text-sm border-b-2 border-transparent hover:bg-[#1c1917]/50 cursor-pointer transition";
                contentSteles.classList.remove('hidden');
                contentReplies.classList.add('hidden');
            } else {
                btnSteles.className = "flex-1 text-center py-4 text-[#78716c] font-medium text-sm border-b-2 border-transparent hover:bg-[#1c1917]/50 cursor-pointer transition";
                btnReplies.className = "flex-1 text-center py-4 text-[#e7e5e4] font-bold text-sm border-b-2 border-[#c5a059] hover:bg-[#1c1917]/50 cursor-pointer transition";
                contentSteles.classList.add('hidden');
                contentReplies.classList.remove('hidden');
            }
        }
    </script>
{% endblock %}
